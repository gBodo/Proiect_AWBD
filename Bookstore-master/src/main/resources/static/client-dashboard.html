<!DOCTYPE html>
<html>
<head>
    <title>Client Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<div class="d-flex justify-content-end mb-3">
    <button id="logoutBtn" class="btn btn-danger">Logout</button>
</div>
<h2>Client Dashboard</h2>
<p>Welcome! Here are the books available:</p>

<div id="message" class="mb-3"></div>

<!-- Filters and Sorting -->
<div class="mb-3 row g-2">
    <div class="col-md-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by title">
    </div>
    <div class="col-md-4">
        <select id="categorySelect" class="form-select">
            <option value="">All Categories</option>
        </select>
    </div>
    <div class="col-md-4">
        <select id="sortSelect" class="form-select">
            <option value="">Sort by</option>
            <option value="title">Title</option>
            <option value="price">Price</option>
        </select>
    </div>
</div>

<div id="bookList" class="row row-cols-1 row-cols-md-3 g-4"></div>

<!-- Pagination -->
<div class="mt-4">
    <button id="prevPage" class="btn btn-secondary">Previous</button>
    <span id="pageInfo" class="mx-2"></span>
    <button id="nextPage" class="btn btn-secondary">Next</button>
</div>

<script>
    function parseJwt(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
            '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
    }

    const token = localStorage.getItem('jwt');
    if (!token) window.location.href = 'login.html';
    else {
        const payload = parseJwt(token);
        const roles = payload.role || payload.roles || payload.authorities;
        if (!roles.includes('CLIENT')) window.location.href = 'login.html';
    }

    const messageDiv = document.getElementById('message');
    const bookList = document.getElementById('bookList');
    const searchInput = document.getElementById('searchInput');
    const categorySelect = document.getElementById('categorySelect');
    const sortSelect = document.getElementById('sortSelect');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');

    let currentPage = 0;
    const pageSize = 5;
    let totalPages = 1;

    // Fetch categories
    async function fetchCategories() {
        try {
            const res = await fetch('/api/categories', { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                const categories = await res.json();
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    categorySelect.appendChild(option);
                });
            }
        } catch (err) {
            console.error("Failed to load categories", err);
        }
    }

    // Fetch books with pagination, filters, and sorting
    async function fetchBooks() {
        try {
            const search = searchInput.value;
            const category = categorySelect.value;
            const sortBy = sortSelect.value;

            let url = `/api/books?page=${currentPage}&size=${pageSize}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (category) url += `&category=${category}`;
            if (sortBy) url += `&sortBy=${sortBy}`;

            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) {
                messageDiv.innerHTML = res.status === 403 ? `<div class="alert alert-danger">You are not authorized to view books.</div>` : `<div class="alert alert-danger">Failed to fetch books.</div>`;
                return;
            }

            const data = await res.json();
            const books = data.content || data;
            totalPages = data.totalPages || 1;

            bookList.innerHTML = '';
            pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;
            prevPage.disabled = currentPage === 0;
            nextPage.disabled = currentPage + 1 >= totalPages;

            if (books.length === 0) {
                messageDiv.innerHTML = `<div class="alert alert-info">No books available.</div>`;
                return;
            }

            books.forEach(book => {
                const col = document.createElement('div');
                col.classList.add('col');
                col.innerHTML = `
        <div class="card h-100">
            <img src="${book.coverImageUrl}" class="card-img-top" alt="${book.title}" style="height: 200px; object-fit: cover;">
            <div class="card-body">
                <h5 class="card-title">${book.title}</h5>
                <button class="btn btn-sm btn-info toggle-details">View Details</button>
                <div class="book-details mt-2" style="display:none;"></div>
            </div>
        </div>
    `;

                const btn = col.querySelector('.toggle-details');
                const detailsDiv = col.querySelector('.book-details');
                btn.addEventListener('click', async () => {
                    if (detailsDiv.style.display === 'none') {
                        try {
                            const res = await fetch(`/api/books/${book.id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                            if (res.ok) {
                                const b = await res.json();
                                detailsDiv.innerHTML = `
                        <p><strong>Author:</strong> ${b.authors.join(', ')}</p>
                        <p><strong>Category:</strong> ${b.category ? b.category.name : 'N/A'}</p>
                        <p><strong>Price:</strong> $${b.price}</p>
                        <img src="${b.coverImageUrl}" alt="${b.title}" style="max-width:150px;">
                    `;
                                detailsDiv.style.display = 'block';
                                btn.textContent = 'Hide Details';
                            } else if (res.status === 403) detailsDiv.innerHTML = `<div class="alert alert-danger">You are not authorized to view this book.</div>`;
                            else detailsDiv.innerHTML = `<div class="alert alert-danger">Failed to fetch book details.</div>`;
                        } catch (err) {
                            detailsDiv.innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
                        }
                    } else {
                        detailsDiv.style.display = 'none';
                        btn.textContent = 'View Details';
                    }
                });

                bookList.appendChild(col);
            });


        } catch (err) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
        }
    }

    // Event listeners
    searchInput.addEventListener('input', () => { currentPage = 0; fetchBooks(); });
    categorySelect.addEventListener('change', () => { currentPage = 0; fetchBooks(); });
    sortSelect.addEventListener('change', () => { currentPage = 0; fetchBooks(); });
    prevPage.addEventListener('click', () => { if (currentPage > 0) { currentPage--; fetchBooks(); } });
    nextPage.addEventListener('click', () => { if (currentPage + 1 < totalPages) { currentPage++; fetchBooks(); } });

    fetchCategories();
    fetchBooks();

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
        // Remove the JWT token from localStorage
        localStorage.removeItem('jwt');
        // Redirect to the homepage
        window.location.href = 'homepage.html';
    });


</script>
</body>
</html>
